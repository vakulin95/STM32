#include <stdio.h>
#include <stdlib.h>
#include "stm32f4xx.h"
#include "diag/Trace.h"

#pragma GCC diagnostic push
#pragma GCC diagnostic ignored "-Wunused-parameter"
#pragma GCC diagnostic ignored "-Wmissing-declarations"
#pragma GCC diagnostic ignored "-Wreturn-type"

void SystemClockConfig(void);
void ConfigureADC(void);
void InitializePA5(void);

ADC_HandleTypeDef g_AdcHandle;
uint32_t g_ADCValue;
int g_MeasurementNumber;

int main(int argc, char* argv[])
{
	SystemClockConfig();
	ConfigureADC();

	HAL_ADC_Start(&g_AdcHandle);
	for (;;)
	{
		if (HAL_ADC_PollForConversion(&g_AdcHandle, 1000000) == HAL_OK)
		{
			g_ADCValue = HAL_ADC_GetValue(&g_AdcHandle);
			g_MeasurementNumber++;
		}
	}
}

void SystemClockConfig(void)
{
	RCC->CFGR &= ~(RCC_CFGR_SW);
	RCC->CFGR |= RCC_CFGR_SW_HSE;

	//SystemCoreClockUpdate();
}

void InitializePA5(void)
{
	GPIO_InitTypeDef PinA5;

	__GPIOA_CLK_ENABLE();

	PinA5.Pin = GPIO_PIN_5;
	PinA5.Mode = GPIO_MODE_OUTPUT_PP;
	PinA5.Speed = GPIO_SPEED_FREQ_LOW;
	PinA5.Pull = GPIO_NOPULL;

	HAL_GPIO_Init(GPIOA, &PinA5);
}

void ConfigureADC(void)
{
    GPIO_InitTypeDef gpioInit;

    __GPIOA_CLK_ENABLE();
    __ADC1_CLK_ENABLE();

    gpioInit.Pin = GPIO_PIN_5;
    //gpioInit.Mode = GPIO_MODE_ANALOG;
    gpioInit.Mode = GPIO_MODE_OUTPUT_PP;
    gpioInit.Pull = GPIO_NOPULL;
    HAL_GPIO_Init(GPIOA, &gpioInit);

    HAL_NVIC_SetPriority(ADC_IRQn, 0, 0);
    HAL_NVIC_EnableIRQ(ADC_IRQn);

    g_AdcHandle.Instance = ADC1;

    g_AdcHandle.Init.ClockPrescaler = ADC_CLOCKPRESCALER_PCLK_DIV2;
    g_AdcHandle.Init.Resolution = ADC_RESOLUTION_12B;
    g_AdcHandle.Init.ScanConvMode = DISABLE;
    g_AdcHandle.Init.ContinuousConvMode = ENABLE;
    g_AdcHandle.Init.DiscontinuousConvMode = DISABLE;
    g_AdcHandle.Init.NbrOfDiscConversion = 0;
    g_AdcHandle.Init.ExternalTrigConvEdge = ADC_EXTERNALTRIGCONVEDGE_NONE;
    g_AdcHandle.Init.ExternalTrigConv = ADC_EXTERNALTRIGCONV_T1_CC1;
    g_AdcHandle.Init.DataAlign = ADC_DATAALIGN_RIGHT;
    g_AdcHandle.Init.NbrOfConversion = 1;
    g_AdcHandle.Init.DMAContinuousRequests = ENABLE;
    g_AdcHandle.Init.EOCSelection = DISABLE;

    HAL_ADC_Init(&g_AdcHandle);

    ADC_ChannelConfTypeDef adcChannel;

    adcChannel.Channel = ADC_CHANNEL_11;
    adcChannel.Rank = 1;
    adcChannel.SamplingTime = ADC_SAMPLETIME_480CYCLES;
    adcChannel.Offset = 0;

    if (HAL_ADC_ConfigChannel(&g_AdcHandle, &adcChannel) != HAL_OK)
    {
        asm("bkpt 255");
    }
}

#pragma GCC diagnostic pop

// ----------------------------------------------------------------------------
